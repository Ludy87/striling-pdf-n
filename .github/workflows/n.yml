name: Build Stirling-PDF Tauri (spdf-tauri)

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch/Tag/Commit von Stirling-PDF (z.B. main, V2-master, v2.0.0)"
        required: false
        default: "main"
      platform:
        description: "Platform to build"
        required: true
        default: "linux"
        type: choice
        options: [linux]
        # options: [all, windows, macos, linux]
      bundle:
        description: "Bundle format to build (e.g., deb, rpm, appimage)"
        required: true
        default: "appimage"
        type: choice
        options: [deb, rpm, appimage]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref_name || github.ref }}
  cancel-in-progress: true

jobs:
  build-tauri:
    name: Build Tauri (${{ matrix.name }}) ${{ github.event.inputs.bundle }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # - name: windows
          #   os: windows-latest
          # - name: macos
          #   os: macos-latest
          - name: linux
            os: ubuntu-22.04

    steps:
      - name: Decide if this platform should run
        shell: bash
        run: |
          PLATFORM="${{ github.event.inputs.platform }}"
          if [ -z "$PLATFORM" ]; then PLATFORM="all"; fi
          if [ "$PLATFORM" != "all" ] && [ "$PLATFORM" != "${{ matrix.name }}" ]; then
            echo "Skipping platform ${{ matrix.name }} because input platform=$PLATFORM"
            exit 0
          fi

      - name: Checkout Stirling-PDF
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          repository: Stirling-Tools/Stirling-PDF
          ref: ${{ github.event.inputs.ref }}
          path: stirling-pdf

      # Linux deps for Tauri/WebKit
      - name: Install dependencies (Linux only)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update

          sudo apt-get install -y \
            build-essential \
            curl \
            wget \
            file \
            libgtk-3-dev \
            libxdo-dev \
            libssl-dev \
            libappindicator3-dev \
            librsvg2-dev \
            openjdk-17-jre-headless \
            patchelf
            
          mkdir -p /tmp/ubuntu-packages
          cd /tmp/ubuntu-packages
          wget https://launchpadlibrarian.net/723972773/libwebkit2gtk-4.1-0_2.44.0-0ubuntu0.22.04.1_amd64.deb || { echo "Failed to download libwebkit2gtk-4.1-0"; exit 1; }
          wget https://launchpadlibrarian.net/723972761/libwebkit2gtk-4.1-dev_2.44.0-0ubuntu0.22.04.1_amd64.deb || { echo "Failed to download libwebkit2gtk-4.1-dev"; exit 1; }
          wget https://launchpadlibrarian.net/723972770/libjavascriptcoregtk-4.1-0_2.44.0-0ubuntu0.22.04.1_amd64.deb || { echo "Failed to download libjavascriptcoregtk-4.1-0"; exit 1; }
          wget https://launchpadlibrarian.net/723972746/libjavascriptcoregtk-4.1-dev_2.44.0-0ubuntu0.22.04.1_amd64.deb || { echo "Failed to download libjavascriptcoregtk-4.1-dev"; exit 1; }
          wget https://launchpadlibrarian.net/723972735/gir1.2-javascriptcoregtk-4.1_2.44.0-0ubuntu0.22.04.1_amd64.deb || { echo "Failed to download gir1.2-javascriptcoregtk-4.1"; exit 1; }
          wget https://launchpadlibrarian.net/723972739/gir1.2-webkit2-4.1_2.44.0-0ubuntu0.22.04.1_amd64.deb || { echo "Failed to download gir1.2-webkit2-4.1"; exit 1; }
          wget https://launchpadlibrarian.net/606433947/libicu70_70.1-2ubuntu1_amd64.deb || { echo "Failed to download libicu70"; exit 1; }
          wget https://launchpadlibrarian.net/606433941/libicu-dev_70.1-2ubuntu1_amd64.deb || { echo "Failed to download libicu-dev"; exit 1; }
          wget https://launchpadlibrarian.net/606433945/icu-devtools_70.1-2ubuntu1_amd64.deb || { echo "Failed to download icu-devtools"; exit 1; }
          wget https://launchpadlibrarian.net/595623693/libjpeg8_8c-2ubuntu10_amd64.deb || { echo "Failed to download libjpeg8"; exit 1; }
          wget https://launchpadlibrarian.net/587202140/libjpeg-turbo8_2.1.2-0ubuntu1_amd64.deb || { echo "Failed to download libjpeg-turbo8"; exit 1; }
          wget https://launchpadlibrarian.net/592959859/xdg-desktop-portal-gtk_1.14.0-1build1_amd64.deb || { echo "Failed to download xdg-desktop-portal-gtk"; exit 1; }
          sudo apt-get install -y /tmp/ubuntu-packages/*.deb

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: stirling-pdf/frontend/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: stable

      - name: Setup JDK 21
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
        with:
          gradle-version: 8.14

      - name: Build Java backend (JAR)
        working-directory: stirling-pdf
        shell: bash
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test -x sonarqube -x spotlessApply -x spotlessCheck

          JAR=$(ls app/core/build/libs/stirling-pdf-*.jar | head -n 1)
          echo "Built JAR: $JAR"

          mkdir -p ./frontend/src-tauri/libs
          cp "$JAR" ./frontend/src-tauri/libs/
        env:
          DISABLE_ADDITIONAL_FEATURES: true

      - name: Create custom JRE via jlink (optional but matches upstream workflow)
        working-directory: stirling-pdf
        shell: bash
        run: |
          JAR=$(ls app/core/build/libs/stirling-pdf-*.jar | head -n 1)

          mkdir -p ./frontend/src-tauri/runtime
          rm -rf ./frontend/src-tauri/runtime/jre

          if command -v jdeps >/dev/null 2>&1; then
            DETECTED=$(jdeps --print-module-deps --ignore-missing-deps "$JAR" 2>/dev/null || true)
          else
            DETECTED=""
          fi

          if [ -n "$DETECTED" ]; then
            MODULES="$DETECTED,java.compiler,java.instrument,java.management,java.naming,java.net.http,java.prefs,java.rmi,java.scripting,java.security.jgss,java.security.sasl,java.sql,java.transaction.xa,java.xml.crypto,jdk.crypto.ec,jdk.crypto.cryptoki,jdk.unsupported"
          else
            MODULES="java.base,java.compiler,java.desktop,java.instrument,java.logging,java.management,java.naming,java.net.http,java.prefs,java.rmi,java.scripting,java.security.jgss,java.security.sasl,java.sql,java.transaction.xa,java.xml,java.xml.crypto,jdk.crypto.ec,jdk.crypto.cryptoki,jdk.unsupported"
          fi

          echo "Using modules: $MODULES"

          jlink \
            --add-modules "$MODULES" \
            --strip-debug \
            --compress=2 \
            --no-header-files \
            --no-man-pages \
            --output ./frontend/src-tauri/runtime/jre

          ./frontend/src-tauri/runtime/jre/bin/java --version

      - name: Install frontend dependencies
        working-directory: stirling-pdf/frontend
        run: npm ci

      - name: Build Tauri app
        if: matrix.os == 'windows-latest'
        working-directory: stirling-pdf/frontend
        shell: bash
        run: |
          # Build with bundling (installer/bundle output)
          npm run tauri-build

      - name: Build Tauri app Ubuntu
        if: matrix.os == 'ubuntu-22.04' && github.event.inputs.bundle == 'appimage'
        working-directory: stirling-pdf/frontend
        shell: bash
        run: |
          # Build with bundling (installer/bundle output)
          npx tauri -t x86_64-unknown-linux-gnu -b appimage

      - name: Collect artifacts (only final installers)
        working-directory: stirling-pdf
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p ./dist
          TARGET_DIR="./frontend/src-tauri/target"

          echo "Searching build outputs under: $TARGET_DIR"
          test -d "$TARGET_DIR" || { echo "ERROR: target dir not found: $TARGET_DIR"; exit 1; }

          # Helper: pick a single file for a pattern (newest if multiple)
          pick_one () {
            local pattern="$1"
            local label="$2"

            # Search recursively, sort by mtime (newest first)
            local found
            found=$(find "$TARGET_DIR" -type f -name "$pattern" -printf '%T@ %p\n' 2>/dev/null | sort -nr | head -n 1 | cut -d' ' -f2- || true)

            if [ -z "${found:-}" ]; then
              echo "ERROR: Could not find $label ($pattern) under $TARGET_DIR"
              exit 1
            fi

            echo "✅ Found $label: $found"
            cp "$found" ./dist/
          }

          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            # Only MSI
            pick_one "*.msi" "Windows MSI"

          elif [ "${{ matrix.os }}" = "macos-latest" ]; then
            # Only DMG
            pick_one "*.dmg" "macOS DMG"

          else
            # Linux: DEB, RPM, AppImage
            pick_one "*.deb" "Linux DEB"
            pick_one "*.rpm" "Linux RPM"

            # AppImage sometimes is placed under bundle/appimage or similar — still matched by recursive find
            pick_one "*.AppImage" "Linux AppImage"
          fi

          echo "==== dist contents ===="
          ls -la ./dist

      - name: Upload per-platform artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: spdf-tauri-${{ matrix.name }}
          path: stirling-pdf/dist/*
          if-no-files-found: error
          retention-days: 1

  # package:
  #   name: Package (spdf-tauri)
  #   runs-on: ubuntu-latest
  #   needs: build-tauri
  #   steps:
  #     - name: Download all platform artifacts
  #       uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
  #       with:
  #         pattern: spdf-tauri-*
  #         path: ./package
  #         merge-multiple: false

  #     - name: Show package structure
  #       run: |
  #         ls -R ./package

  #     - name: Upload combined package artifact (spdf-tauri)
  #       uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
  #       with:
  #         name: spdf-tauri
  #         path: ./package/**
  #         retention-days: 14
